#!/bin/ash
# ======================================
# Velocity Proxy Installation Script
# Updated for PaperMC API (2025)
# ======================================
# Server Files: /mnt/server
PROJECT=velocity
SERVER_DIR=/mnt/server
SERVER_JARFILE=velocity.jar

# Get latest version if not specified
if [ -z "${VELOCITY_VERSION}" ] || [ "${VELOCITY_VERSION}" = "latest" ]; then
    echo "Fetching latest Velocity version..."
    VELOCITY_VERSION=$(curl -s https://api.papermc.io/v2/projects/${PROJECT} | jq -r '.versions[-1]')
fi

# Get latest build number for that version
BUILD_NUMBER=$(curl -s https://api.papermc.io/v2/projects/${PROJECT}/versions/${VELOCITY_VERSION} | jq -r '.builds[-1]')

# Build jar name and download URL
JAR_NAME="${PROJECT}-${VELOCITY_VERSION}-${BUILD_NUMBER}.jar"
DOWNLOAD_URL="https://api.papermc.io/v2/projects/${PROJECT}/versions/${VELOCITY_VERSION}/builds/${BUILD_NUMBER}/downloads/${JAR_NAME}"

echo "-----------------------------------------"
echo "Velocity Version: ${VELOCITY_VERSION}"
echo "Build Number: ${BUILD_NUMBER}"
echo "Download URL: ${DOWNLOAD_URL}"
echo "-----------------------------------------"

cd ${SERVER_DIR}

# Backup any existing jar
if [ -f "${SERVER_JARFILE}" ]; then
    mv ${SERVER_JARFILE} ${SERVER_JARFILE}.old
fi

# Download the actual Velocity jar
echo "Downloading Velocity from PaperMC..."
curl -L -o ${SERVER_JARFILE} ${DOWNLOAD_URL}

# Validate file
if [ ! -s "${SERVER_JARFILE}" ]; then
    echo "ERROR: Download failed or jar is empty!"
    exit 1
fi

# Handle config
if [ ! -f velocity.toml ]; then
    echo "Creating default velocity.toml..."
    cat <<EOF > velocity.toml
# Default Velocity config generated by egg
config-version = "2"
bind = "0.0.0.0:25577"
motd = "A Velocity Server"
show-max-players = 100
online-mode = true
EOF
else
    echo "velocity.toml already exists."
fi

# Forwarding secret
if [ ! -f forwarding.secret ]; then
    echo "Creating forwarding.secret..."
    date +%s | sha256sum | base64 | head -c 12 > forwarding.secret
else
    echo "forwarding.secret already exists."
fi

echo "âœ… Velocity installation complete!"
